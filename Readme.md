# IT Email Transfer tool  


This is a tool to transfer a mailbox from a user account to another user account. This tool is written using the node.js framework.  

**Table of contents:**  

- [IT Email Transfer tool](#it-email-transfer-tool)
	- [How it works](#how-it-works)
	- [Installing the application](#installing-the-application)
		- [Prerequisites](#prerequisites)
		- [Installation](#installation)
	- [Running Scripts](#running-scripts)
	- [Authentication](#authentication)
	- [Jsdoc Documentation](#jsdoc-documentation)
	- [Migration](#migration)
		- [**Stage 1**](#stage-1)
		- [**Stage 2**](#stage-2)
	- [Database Setup](#database-setup)
		- [**Transfer Log**](#transfer-log)
		- [**Error Log**](#error-log)
		- [**Operation Status**](#operation-status)
		- [**Finished Transfers**](#finished-transfers)
		- [**Message Info**](#message-info)
		- [**Label Info**](#label-info)
	- [Troubleshooting](#troubleshooting)
		- [**Possible errors encountered:**](#possible-errors-encountered)


## How it works  

* The tool works by first retrieving the data it needs from a spreadsheet containing the source and destination email address, metadata on the row, column and status fields of the email addresses.  
* It then begins retreiving the labels of the source account in order to recreate them in the destination mailbox
* Once those labels are recreated in the destination mailbox, it retreives and saves the messages of the source mailbox in the database
* lastly, after all the messages have been saved in the database, it then starts to import them into the destination mailbox - sorting the emails by their earlier created labels

**NOTE**: The tool is called every 10 mins by the task scheduler.

This application works by making a series of calls to the Gmail API.  

## Installing the application  

### Prerequisites
---
* [Node JS environment](https://nodejs.org/en/download/)
* [Mongodb server](https://www.mongodb.com/try/download/community)
* Physical access to terminal or device on first execution
	- This is required for the first time the tool is run for **authenticaion purposes** on the spreadsheet.
* Credential file for [JWT](#authentication) Authentication
* Appropriate naming in ***.env*** file

### Installation  
---
Once you have downloaded the files..  

``` bash
npm install
```

It's literally as simple as that!  

## Running Scripts  

There are different commands the script can run depending on the current state of the operation. The script will run `npm start` when the script is initially executed and will run `npm run cont` when it needs to continue from where it left off. 

## Authentication  

The application uses JSON Web Tokens(JWT) and OAuth2 to authenticate to the respective APIs in use. You can read more about them:  

[JWT](https://github.com/googleapis/google-auth-library-nodejs#json-web-tokens) | [OAuth2](https://github.com/googleapis/google-auth-library-nodejs#oauth2)
:-------------: | :-------------:
JWT is used to authenticate to the GMAIL API as its a server <---> server operation  | OAuth2 isused to authenticate the script to the SpreadSheet, server account cannot be used in this instance.  

## Jsdoc Documentation  

In order to create a jsdoc documentation, I have included a script to run as well as a configuration file for [JSDOC]().  
Command to run jsdoc on file structure.  

``` bash
sh createDoc 
```
To regenerate the doc, please use this instead...  

```bash
sh regenerateDoc  
```  

Once the jsdoc is created, you will need to start a server in the "**out**" directory using:  

```python
python3 -m http.server <port> #replace with an avaialable port (without angle brackets)  
#e.g python3 -m http.server 80  
```
You can use any means to create a server to view the doc in the browser, I found the python module the easiest to use!  

## Migration
---
There might be a situation where the tool needs to be moved from one server to another, in such case there are steps that can be followed to do execly that.

These steps aims to ensure you are able to migrate the tool efficiently and without errors.
<br/> <br/>

### **Stage 1**
---

*	Back up the database (by either using **mongodump(if database size isn't large)** or **mongoexport** on each collection)
	*	Example code to export the database:
		```bash
		mongodump -d <database_name> -o <directory_backup>
		```
*	Back up necessary code files except node modules or anything that can be regenerated by npm or jsdoc.
*	Export the scheduler (**on import, ensure the settings are adequate for the new environment**)
*	Re-install software used by the tool
	* nodejs
	* mongodb (exe that will also install mongo compass if you want a more visual view of the database)
	* Mongodb server database tools
	* If you are running on windows, git bash, or any tool that is able to use linux commands (if you use a different software other than git-bash, you will need to change the command run by the scheduler)

### **Stage 2**
---
Once all those steps have been followed, you can finish the migration process by following these steps:

*	Restore the databse by using **mongorestore** or **mongoimport**.
	- Example restore
	```bash
	mongorestore -d <database_name> <direcory_where_exported_files are>
	```
 The mongodump and mongorestore combination are suitable for the tool as the database should not be too large. In cases where the database is large, mongodump wouldn't be the best solution to export data. 
*	Import the task scheduler in order for the tool to run automatically (disbale the scheduler for the time being. Enable when tests have been done)
*	Make sure env file is updated accurately. Some systems will accept ***mongodb://locahost:27017*** as the connection string but some may require the ip address instead.
*	Test to make sure the tool runs as it should
	- can test by running npm start from the root directory of the tool

<br/>

## Database Setup

The Database is a mongodb database called transfer with six collections performing different operations;

* [transfer_log](#transfer-log)
* [error_log](#error-log)
* [operation_status](#operation-status)
* [finshed_transfers](#finished-transfers)
* [message_info](#message-info)
* [label_data](#label-info)

### **Transfer Log**
---
The transfer_log collection store information about failed transfers for any ongoing transfer. Information stored in this collection are:
*	ID of the message to be transfered
*	username/email of the user being transfered
<br/><br/>

### **Error Log**
---

The error_log collection is a more detailed version of the transfer_log, the error log stores information about:
*	The request that was made to the GMAIL API that caused an error or unsuccessful transfer of a message
*	The error message returned by the REST API endpoint
*	Originating account of the email message

You can use the error_log/transfer log to perform retransfers of messages, however the error_log allows for more informed decisions on re-transfers
<br/><br/>


### **Operation Status**
---

The operation_status collection is where the current state of the tool is stored, this is where the tool retrieves information needed to resume a transfer or start a new one. The collection is essential to the proper running of the transfer tool.
<br/><br/>

### **Finished Transfers**
---

The finished_transfer is simply where completed transfers are moved to.
<br/><br/>

### **Message Info**
---

The message_info is where details of the email messages to be transfered are stored. All the ID's of the messages to be transfered (per-user) are stored in this collection.
The tool uses this collection to retrieve the next message to be transfered.
<br/><br/>

### **Label Info**
---

The label_info collcetion is where the label information for the destination account is stored, it is used for each request to the GMAIL REST API to import messages.

**[Back to top](#top)**


## Troubleshooting

There are many way of troubleshooting when there is an issue with the tool. This section aims to walk you throught the usual issues encountered and possible solutions to deal with them.
The tool has a log where details of the running tool are kept, this can be found in the logs directory, which can be found [here](./src/logging/logs) *****only available after it has logged some data**.  
When errors are spotted, it is advisable to check these logs first as it is the best aread to find intial details of any error that may have occured.

### **Possible errors encountered:**

*	**label already exesting in the destination account**
	*	this error means that the label which the emails will be kept under has already been created in the destination account. This error could arise from the same account being migrated to the same destination account or a simutaneous execution of a transfer. <br>
	There aren't any actions to take on any of the accounts, the solution is to advance the execution to the next stage which is *"listandSaveMsg"*<br><br>

	**To do this:**
	*	access the mongoDB database and find the current executing transfer in the **operation_status** collection and change the value of "stage to "listandSaveMsg" (without the quotes).
	When the tool resumes, it should continue from the next stage. This error has a very low probability of occuring however, in such an occassion it is better to know how to deal with it.<br><br>

*	**Tool not automatically picking up a new transfer entry**<br><br>
	There are times when the tool may not pickup a new entry on the spreadsheet, the best thing to do in this scenario is restart the IT Email Transfer server. <br>
	If nothing changes, follow these steps before manually running the tool from the task scheduler.
	*	open the directory holding the transfer tool, a shortcut should be on your desktop.
		*	right click an emty space in the folder and click open with git bash (this opens the directory in the bash terminal)
		*	run the tool by typing ` sh ./scripts/automate.sh ` this command tries to run the tool and continue from where it left off or start a new transfer.(take note of the messages that may come up)
			*	if the tool carries on from where it left off then it is working fine but may not automatically resume until the task scheduler kicks in (scheduler kicks in from 10:30 in the morning so any pause in the schedule will stop it from resuming normally until the ext cycle).
			*	In the case that the messages printed on the screen don't indicate the tool is contunuing from where it stopped, take appropriate action according to the error message which should be one of the errors covered in this troubleshooting section.

*	

